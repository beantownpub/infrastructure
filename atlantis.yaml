version: 3
projects:
- dir: dev
  name: dev
  workspace: development
  autoplan:
    enabled: true
    when_modified: ["**/*.tf*", "../modules/**/*.tf*"]
  workflow: custom_plan
- dir: prod
  name: prod
  workspace: production
  autoplan:
    enabled: true
    when_modified: ["**/*.tf*", "../modules/**/*.tf*"]
  workflow: workspace_plan

workflows:
  custom_plan:
    plan:
      steps:
      - run: |
          echo "Workspace: ${WORKSPACE}"
          echo "Directory: ${PWD}"
          export TF_WORKSPACE=${WORKSPACE}
          terraform init -no-color
          terraform plan -no-color -input=false -refresh -out $PLANFILE
